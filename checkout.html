<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDhpg4IakcXJ9AuDQabyJifOAu1G12x38o",
    authDomain: "mohamad-1473c.firebaseapp.com",
    projectId: "mohamad-1473c",
    storageBucket: "mohamad-1473c.firebasestorage.app",
    messagingSenderId: "174549108595",
    appId: "1:174549108595:web:c65e29101d41e76ea42706",
    measurementId: "G-DC0NQYPE3J"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    try {
      // ذخیره سفارش در Firestore
      await addDoc(collection(db, "orders"), {
        name,
        phone,
        cart,
        createdAt: serverTimestamp()
      });

      // ارسال به واتساپ (مثل قبل)
      let message = `سفارش جدید:%0A`;
      message += `نام: ${name}%0A`;
      message += `شماره: ${phone}%0A`;
      message += `محصولات:%0A`;
      cart.forEach(item => {
        message += `- ${item.name}%0A`;
      });

      window.open(`https://wa.me/989918263754?text=${message}`, "_blank");

      alert("سفارش شما ثبت شد ✅");
      localStorage.removeItem("cart");
      window.location.href = "shop.html";
    } catch (error) {
      console.error("خطا در ذخیره سفارش:", error);
      alert("مشکلی پیش آمد، دوباره امتحان کنید.");
    }
  });
</script>
